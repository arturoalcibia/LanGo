<script src="https://code.jquery.com/jquery-1.12.4.js"></script>

<p>Enter a youtube url.</p>

<form id="form" method="POST">
    {{ videoUrlForm.csrf_token }}
    <p>{{ videoUrlForm.url(size=32, autocomplete="off") }}</p>
    {{ videoUrlForm.search }}
</form>

<div id="url-error" class="invalid-feedback"></div>

{% for videoDivKey in videoDivKeys %}
    <div id="{{ videoDivKey }}"></div>
{% endfor %}

<div id="video">
</div>

<script>
    const form = document.getElementById('form');

    const fields = {
        csrf_token: {
            input: document.getElementById('csrf_token'),
        },
        url: {
            input: document.getElementById('url'),
            error: document.getElementById('url-error'),
            ok: document.getElementById('video')
        },
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const response = await fetch('/browseurl/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                csrf_token: fields.csrf_token.input.value,
                url: fields.url.input.value,
            })
        });
        if (response.ok) {
            const videoInfo = await response.json();
            Object.keys(videoInfo).forEach((key) => {
                let videoInfoDiv = document.getElementById(key)

                if (videoInfoDiv === null)
                    return

                videoInfoDiv.innerText = videoInfo[key];

            });
        } else {
            const errors = await response.json();
            Object.keys(errors).forEach((key) => {
                fields[key].input.classList.add('is-invalid');
                fields[key].error.innerHTML = errors[key][0];
            });
        }
    });
</script>